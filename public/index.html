<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Ahorro Energético - GrupoABSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.5.0/dist/Recharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .metric-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
        }
        .chat-message {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const EnergyCalculator = () => {
            // Estados para los inputs
            const [inputs, setInputs] = useState({
                motors: 1,
                hpPerMotor: 10,
                loadFactor: 90,
                operationHours: 2500,
                electricityRate: 2.5,
                driveSavings: 30,
                avoidedStopHours: 40,
                stopCostPerHour: 25000,
                currentMaintenance: 10000,
                maintenanceReduction: 30,
                packageCostPerMotor: 2400,
                projectHorizon: 5
            });

            const [results, setResults] = useState(null);
            const [presets, setPresets] = useState({});
            const [selectedPreset, setSelectedPreset] = useState('bombas-ventiladores');
            const [calculating, setCalculating] = useState(false);
            
            // Estados para el chat
            const [messages, setMessages] = useState([
                { role: 'assistant', content: '¡Hola! Soy tu asistente experto en eficiencia energética. ¿En qué puedo ayudarte hoy?' }
            ]);
            const [inputMessage, setInputMessage] = useState('');
            const [chatLoading, setChatLoading] = useState(false);
            const chatContainerRef = useRef(null);

            // Cargar presets al iniciar
            useEffect(() => {
                loadPresets();
            }, []);

            // Scroll automático en el chat
            useEffect(() => {
                if (chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [messages]);

            const loadPresets = async () => {
                try {
                    const response = await fetch('/api/presets');
                    const data = await response.json();
                    setPresets(data);
                    // Cargar el primer preset por defecto
                    if (data['bombas-ventiladores']) {
                        setInputs(data['bombas-ventiladores']);
                    }
                } catch (error) {
                    console.error('Error cargando presets:', error);
                }
            };

            const handlePresetChange = (presetKey) => {
                setSelectedPreset(presetKey);
                if (presets[presetKey]) {
                    setInputs(presets[presetKey]);
                }
            };

            const handleInputChange = (field, value) => {
                setInputs(prev => ({
                    ...prev,
                    [field]: parseFloat(value) || 0
                }));
            };

            const calculateSavings = async () => {
                setCalculating(true);
                try {
                    const response = await fetch('/api/calculate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(inputs)
                    });
                    const data = await response.json();
                    setResults(data);
                } catch (error) {
                    console.error('Error calculando:', error);
                    alert('Error al calcular los ahorros');
                } finally {
                    setCalculating(false);
                }
            };

            const sendMessage = async () => {
                if (!inputMessage.trim()) return;

                const userMessage = inputMessage;
                setInputMessage('');
                setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
                setChatLoading(true);

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: userMessage,
                            context: results ? { inputs, results } : null
                        })
                    });
                    const data = await response.json();
                    setMessages(prev => [...prev, { role: 'assistant', content: data.response }]);
                } catch (error) {
                    console.error('Error en chat:', error);
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: 'Lo siento, hubo un error al procesar tu mensaje. Por favor, intenta de nuevo.' 
                    }]);
                } finally {
                    setChatLoading(false);
                }
            };

            const exportToPDF = async () => {
                if (!results) return;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Título
                doc.setFontSize(20);
                doc.setTextColor(102, 126, 234);
                doc.text('Reporte de Ahorro Energético', 20, 20);
                
                // Fecha
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 20, 30);
                
                // Parámetros de entrada
                doc.setFontSize(14);
                doc.setTextColor(0);
                doc.text('Parámetros de Entrada:', 20, 45);
                
                doc.setFontSize(10);
                let y = 55;
                doc.text(`Motores: ${inputs.motors}`, 25, y);
                doc.text(`HP por motor: ${inputs.hpPerMotor}`, 25, y + 7);
                doc.text(`Factor de carga: ${inputs.loadFactor}%`, 25, y + 14);
                doc.text(`Horas de operación/año: ${inputs.operationHours}`, 25, y + 21);
                doc.text(`Tarifa eléctrica: $${inputs.electricityRate}/kWh`, 25, y + 28);
                
                // Resultados
                doc.setFontSize(14);
                doc.text('Resultados del Análisis:', 20, y + 45);
                
                doc.setFontSize(10);
                y = y + 55;
                doc.text(`Consumo actual: ${results.currentConsumption.toFixed(0).toLocaleString()} kWh/año`, 25, y);
                doc.text(`Ahorro energético anual: $${results.energySavings.toFixed(0).toLocaleString()}`, 25, y + 7);
                doc.text(`Ahorro por paros evitados: $${results.stopSavings.toFixed(0).toLocaleString()}`, 25, y + 14);
                doc.text(`Ahorro en mantenimiento: $${results.maintenanceSavings.toFixed(0).toLocaleString()}`, 25, y + 21);
                
                doc.setFontSize(12);
                doc.setTextColor(102, 126, 234);
                doc.text(`Ahorro Total Anual: $${results.totalAnnualSavings.toFixed(0).toLocaleString()}`, 25, y + 35);
                doc.text(`ROI: ${results.annualROI.toFixed(1)}%`, 25, y + 42);
                doc.text(`Payback: ${results.paybackYears.toFixed(2)} años`, 25, y + 49);
                
                // Pie de página
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text('© 2025 GrupoABSA - Calculadora de Ahorro Energético', 20, 280);
                
                // Guardar PDF
                doc.save('reporte-ahorro-energetico.pdf');
            };

            const formatNumber = (num) => {
                return num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="gradient-bg text-white py-8 px-4">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-3xl md:text-4xl font-bold mb-2">
                                        <i className="fas fa-bolt mr-3"></i>
                                        Simulador de Ahorro Energético
                                    </h1>
                                    <p className="text-lg opacity-90">
                                        Drive + Reactor + Guardamotor
                                    </p>
                                </div>
                                <div className="text-right">
                                    <p className="text-sm opacity-80">Powered by</p>
                                    <p className="text-xl font-bold">@GrupoABSA</p>
                                </div>
                            </div>
                            <div className="mt-4 bg-white/10 rounded-lg p-4">
                                <p className="text-sm md:text-base">
                                    <i className="fas fa-info-circle mr-2"></i>
                                    Deja de perder dinero en silencio. Descubre cómo transformar los costos ocultos 
                                    de energía en ahorros medibles y un ROI claro.
                                </p>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-7xl mx-auto px-4 py-8">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Panel de Entrada */}
                            <div className="lg:col-span-1">
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-bold mb-4 text-gray-800">
                                        <i className="fas fa-sliders-h mr-2"></i>
                                        Configuración
                                    </h2>

                                    {/* Selector de Presets */}
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Preset
                                        </label>
                                        <select 
                                            className="w-full p-2 border rounded-lg"
                                            value={selectedPreset}
                                            onChange={(e) => handlePresetChange(e.target.value)}
                                        >
                                            <option value="bombas-ventiladores">Bombas/Ventiladores</option>
                                            <option value="transportadores">Transportadores</option>
                                            <option value="carga-fija">Carga Fija</option>
                                        </select>
                                    </div>

                                    {/* Inputs */}
                                    <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                Motores (cantidad)
                                            </label>
                                            <input
                                                type="number"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.motors}
                                                onChange={(e) => handleInputChange('motors', e.target.value)}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                HP por motor
                                            </label>
                                            <input
                                                type="number"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.hpPerMotor}
                                                onChange={(e) => handleInputChange('hpPerMotor', e.target.value)}
                                            />
                                            <p className="text-xs text-gray-500 mt-1">
                                                = {(inputs.hpPerMotor * 0.746).toFixed(2)} kW
                                            </p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                Factor de carga (%)
                                            </label>
                                            <input
                                                type="number"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.loadFactor}
                                                onChange={(e) => handleInputChange('loadFactor', e.target.value)}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                Horas de operación/año
                                            </label>
                                            <input
                                                type="number"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.operationHours}
                                                onChange={(e) => handleInputChange('operationHours', e.target.value)}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                Tarifa eléctrica ($/kWh)
                                            </label>
                                            <input
                                                type="number"
                                                step="0.1"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.electricityRate}
                                                onChange={(e) => handleInputChange('electricityRate', e.target.value)}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                Ahorro energético por Drive (%)
                                            </label>
                                            <input
                                                type="number"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.driveSavings}
                                                onChange={(e) => handleInputChange('driveSavings', e.target.value)}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                Horas de paro evitadas/año
                                            </label>
                                            <input
                                                type="number"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.avoidedStopHours}
                                                onChange={(e) => handleInputChange('avoidedStopHours', e.target.value)}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                Costo por hora de paro ($/h)
                                            </label>
                                            <input
                                                type="number"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.stopCostPerHour}
                                                onChange={(e) => handleInputChange('stopCostPerHour', e.target.value)}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                Gasto mantenimiento actual ($/año)
                                            </label>
                                            <input
                                                type="number"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.currentMaintenance}
                                                onChange={(e) => handleInputChange('currentMaintenance', e.target.value)}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                Reducción de mantenimiento (%)
                                            </label>
                                            <input
                                                type="number"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.maintenanceReduction}
                                                onChange={(e) => handleInputChange('maintenanceReduction', e.target.value)}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                Costo del paquete por motor ($)
                                            </label>
                                            <input
                                                type="number"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.packageCostPerMotor}
                                                onChange={(e) => handleInputChange('packageCostPerMotor', e.target.value)}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">
                                                Horizonte de proyecto (años)
                                            </label>
                                            <input
                                                type="number"
                                                className="mt-1 w-full p-2 border rounded"
                                                value={inputs.projectHorizon}
                                                onChange={(e) => handleInputChange('projectHorizon', e.target.value)}
                                            />
                                        </div>
                                    </div>

                                    <button
                                        onClick={calculateSavings}
                                        disabled={calculating}
                                        className="w-full mt-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition disabled:opacity-50"
                                    >
                                        {calculating ? (
                                            <span className="flex items-center justify-center">
                                                <div className="loader mr-2"></div>
                                                Calculando...
                                            </span>
                                        ) : (
                                            <>
                                                <i className="fas fa-calculator mr-2"></i>
                                                Calcular Ahorros
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>

                            {/* Panel de Resultados */}
                            <div className="lg:col-span-2">
                                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-bold text-gray-800">
                                            <i className="fas fa-chart-line mr-2"></i>
                                            Resultados del Simulador
                                        </h2>
                                        {results && (
                                            <button
                                                onClick={exportToPDF}
                                                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                                            >
                                                <i className="fas fa-file-pdf mr-2"></i>
                                                Exportar PDF
                                            </button>
                                        )}
                                    </div>

                                    {results ? (
                                        <div>
                                            {/* Métricas de consumo actual */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                                <div className="bg-gray-50 p-4 rounded-lg">
                                                    <p className="text-sm text-gray-600">Consumo actual</p>
                                                    <p className="text-2xl font-bold text-gray-800">
                                                        {formatNumber(results.currentConsumption)} kWh/año
                                                    </p>
                                                </div>
                                                <div className="bg-gray-50 p-4 rounded-lg">
                                                    <p className="text-sm text-gray-600">Costo de energía actual</p>
                                                    <p className="text-2xl font-bold text-gray-800">
                                                        ${formatNumber(results.currentEnergyCost)}/año
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Métricas de ahorro */}
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                                <div className="metric-card bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <p className="text-sm text-green-700">
                                                                <i className="fas fa-bolt mr-1"></i>
                                                                Ahorro energético
                                                            </p>
                                                            <p className="text-xl font-bold text-green-800">
                                                                ${formatNumber(results.energySavings)}
                                                            </p>
                                                            <p className="text-xs text-green-600">
                                                                {inputs.driveSavings}% de eficiencia
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="metric-card bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <p className="text-sm text-blue-700">
                                                                <i className="fas fa-tools mr-1"></i>
                                                                Paros evitados
                                                            </p>
                                                            <p className="text-xl font-bold text-blue-800">
                                                                ${formatNumber(results.stopSavings)}
                                                            </p>
                                                            <p className="text-xs text-blue-600">
                                                                {inputs.avoidedStopHours} horas recuperadas
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="metric-card bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <p className="text-sm text-purple-700">
                                                                <i className="fas fa-wrench mr-1"></i>
                                                                Mantenimiento
                                                            </p>
                                                            <p className="text-xl font-bold text-purple-800">
                                                                ${formatNumber(results.maintenanceSavings)}
                                                            </p>
                                                            <p className="text-xs text-purple-600">
                                                                {inputs.maintenanceReduction}% reducción
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Métricas principales */}
                                            <div className="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg p-6">
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                                    <div className="text-center">
                                                        <p className="text-sm opacity-90">Ahorro Total Anual</p>
                                                        <p className="text-2xl font-bold">
                                                            ${formatNumber(results.totalAnnualSavings)}
                                                        </p>
                                                    </div>
                                                    <div className="text-center">
                                                        <p className="text-sm opacity-90">Inversión Total</p>
                                                        <p className="text-2xl font-bold">
                                                            ${formatNumber(results.totalInvestment)}
                                                        </p>
                                                    </div>
                                                    <div className="text-center">
                                                        <p className="text-sm opacity-90">Payback</p>
                                                        <p className="text-2xl font-bold">
                                                            {results.paybackYears.toFixed(2)} años
                                                        </p>
                                                    </div>
                                                    <div className="text-center">
                                                        <p className="text-sm opacity-90">ROI Anual</p>
                                                        <p className="text-2xl font-bold">
                                                            {results.annualROI.toFixed(1)}%
                                                        </p>
                                                    </div>
                                                </div>
                                                
                                                <div className="mt-4 pt-4 border-t border-white/30 text-center">
                                                    <p className="text-sm opacity-90">
                                                        <i className="fas fa-lock mr-1"></i>
                                                        Ahorro acumulado en {inputs.projectHorizon} años
                                                    </p>
                                                    <p className="text-3xl font-bold">
                                                        ${formatNumber(results.accumulatedSavings)}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-12 text-gray-500">
                                            <i className="fas fa-chart-area text-6xl mb-4 opacity-30"></i>
                                            <p>Configura los parámetros y haz clic en "Calcular Ahorros"</p>
                                            <p className="text-sm mt-2">Los resultados aparecerán aquí</p>
                                        </div>
                                    )}
                                </div>

                                {/* Chat con IA */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-bold mb-4 text-gray-800">
                                        <i className="fas fa-robot mr-2"></i>
                                        Asistente IA - Experto en Eficiencia Energética
                                    </h2>
                                    
                                    <div 
                                        ref={chatContainerRef}
                                        className="chat-container bg-gray-50 rounded-lg p-4 mb-4"
                                    >
                                        {messages.map((msg, index) => (
                                            <div 
                                                key={index}
                                                className={`chat-message mb-3 ${msg.role === 'user' ? 'text-right' : 'text-left'}`}
                                            >
                                                <div className={`inline-block max-w-3/4 p-3 rounded-lg ${
                                                    msg.role === 'user' 
                                                        ? 'bg-blue-500 text-white' 
                                                        : 'bg-white text-gray-800 shadow'
                                                }`}>
                                                    {msg.content}
                                                </div>
                                            </div>
                                        ))}
                                        {chatLoading && (
                                            <div className="text-left">
                                                <div className="inline-block bg-white p-3 rounded-lg shadow">
                                                    <div className="loader"></div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            className="flex-1 p-3 border rounded-lg"
                                            placeholder="Pregunta sobre eficiencia energética, ROI, mejores prácticas..."
                                            value={inputMessage}
                                            onChange={(e) => setInputMessage(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                            disabled={chatLoading}
                                        />
                                        <button
                                            onClick={sendMessage}
                                            disabled={chatLoading || !inputMessage.trim()}
                                            className="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:opacity-90 transition disabled:opacity-50"
                                        >
                                            <i className="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                    
                                    <div className="mt-3 text-xs text-gray-500">
                                        <i className="fas fa-info-circle mr-1"></i>
                                        Pregúntame sobre optimización energética, análisis de ROI, o recomendaciones específicas para tu industria.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Footer */}
                    <footer className="bg-gray-800 text-white py-6 mt-12">
                        <div className="max-w-7xl mx-auto px-4 text-center">
                            <p className="mb-2">
                                © 2025 — Simulador de ahorros hecho para acelerar decisiones con datos.
                            </p>
                            <p className="text-sm opacity-70">
                                <i className="fas fa-industry mr-2"></i>
                                @GrupoABSA - Transformando la eficiencia energética industrial
                            </p>
                        </div>
                    </footer>
                </div>
            );
        };

        // Renderizar la aplicación
        ReactDOM.render(<EnergyCalculator />, document.getElementById('root'));
    </script>
</body>
</html>